<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Streaker</title>

    <style>
        /* =====================
       GLOBAL RESET
    ===================== */
    * {
        box-sizing: border-box;
    }

    body {
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        background: linear-gradient(135deg, #eef2ff, #f8fafc);
        margin: 0;
        padding: 0;
        color: #0f172a;
    }

    /* =====================
       MAIN CONTAINER
    ===================== */
    .container {
        max-width: 820px;
        margin: 60px auto;
        background: rgba(255, 255, 255, 0.85);
        backdrop-filter: blur(10px);
        padding: 36px;
        border-radius: 16px;
        box-shadow: 0 20px 40px rgba(15, 23, 42, 0.08);
        border: 1px solid rgba(226, 232, 240, 0.8);
    }

    /* =====================
       HEADINGS
    ===================== */
    h2 {
        text-align: center;
        font-size: 26px;
        font-weight: 700;
        letter-spacing: -0.5px;
    }

    h3 {
        margin-top: 42px;
        font-size: 15px;
        font-weight: 600;
        color: #334155;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    /* =====================
       INPUT GROUPS
    ===================== */
    .input-group {
        display: flex;
        gap: 12px;
        margin-top: 20px;
    }

    /* =====================
       INPUTS & SELECTS
    ===================== */
    input,
    select {
        flex: 1;
        height: 46px;
        padding: 0 14px;
        font-size: 14px;
        border-radius: 10px;
        border: 1px solid #e2e8f0;
        background: #ffffff;
        transition: all 0.2s ease;
    }

    input::placeholder {
        color: #94a3b8;
    }

    input:focus,
    select:focus {
        outline: none;
        border-color: #6366f1;
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.15);
    }

    /* =====================
       BUTTONS
    ===================== */
    button {
        height: 46px;
        padding: 0 20px;
        font-size: 14px;
        font-weight: 600;
        background: linear-gradient(135deg, #6366f1, #4f46e5);
        color: white;
        border: none;
        border-radius: 12px;
        cursor: pointer;
        transition: transform 0.15s ease, box-shadow 0.15s ease;
        box-shadow: 0 10px 20px rgba(79, 70, 229, 0.25);
    }

    button:hover {
        transform: translateY(-1px);
        box-shadow: 0 14px 28px rgba(79, 70, 229, 0.35);
    }

    /* =====================
       HINT TEXT
    ===================== */
    .hint {
        margin-top: 10px;
        font-size: 12px;
        color: #64748b;
        text-align: center;
    }

    /* =====================
       PRACTICE GRID
    ===================== */
    .practice-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 18px;
        margin-top: 24px;
    }

    .practice-grid-full {
        grid-column: span 2;
    }

    /* =====================
       TIMER
    ===================== */
    #timerDisplay {
        margin-top: 14px;
        font-size: 18px;
        font-weight: 700;
        color: #4f46e5;
    }

    /* =====================
       HISTORY / CARDS
    ===================== */
    .history-list {
        margin-top: 18px;
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .history-card {
        padding: 14px 16px;
        border-radius: 14px;
        background: linear-gradient(135deg, #f8fafc, #eef2ff);
        border: 1px solid #e2e8f0;
        font-size: 14px;
        line-height: 1.5;
        transition: transform 0.15s ease, box-shadow 0.15s ease;
    }

    .history-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 12px 24px rgba(15, 23, 42, 0.08);
    }

    /* =====================
       PLAYER
    ===================== */
    .player-wrapper {
        margin-top: 18px;
        display: flex;
        justify-content: center;
    }

    /* =====================
       EMPTY & FOOTER
    ===================== */
    .empty {
        font-size: 13px;
        color: #94a3b8;
    }

    .footer {
        margin-top: 48px;
        font-size: 12px;
        color: #94a3b8;
        text-align: center;
    }


    </style>
</head>
<body>

<div class="container">
    <h2>Streaker</h2>

    <!-- USER PROGRESS DASHBOARD -->
    <h3>üìä Your Learning Progress</h3>
    <div class="history-list" id="progressDashboard">
        <p class="empty">Loading progress...</p>
    </div>

    <!-- YOUTUBE INPUT -->
    <div class="input-group">
        <input type="text" id="ytUrl" placeholder="Paste YouTube video URL">
        <button id="startBtn">Start</button>
    </div>

    <div class="hint">Watch videos only inside this page to track time</div>

    <!-- PRACTICE TIMER -->
    <h3>üß† Practice Timer</h3>
    <div class="input-group">
        <select id="platform">
            <option value="LEETCODE">LeetCode</option>
            <option value="CODECHEF">CodeChef</option>
            <option value="PROJECT">Project</option>
            <option value="READING">Reading</option>
        </select>
        <input type="text" id="topic" placeholder="Topic (Arrays, DP, Graphs)">
    </div>

    <p id="timerDisplay">‚è±Ô∏è 00:00</p>

    <!-- PRACTICE LOG -->
    <h3>üìí Practice Session Log</h3>

    <div class="practice-grid">
        <!-- Skill autocomplete (NO DROPDOWN BUG) -->
        <input
                type="text"
                id="practiceSkillName"
                list="skillsList"
                placeholder="Start typing skill (Java, Spring Boot...)"
        >
        <datalist id="skillsList"></datalist>

        <input type="date" id="practiceDate">

        <input type="number" id="practiceDuration" placeholder="Duration (minutes)">

        <select id="practiceEffort">
            <option value="">Effort Level</option>
            <option value="Low">Low</option>
            <option value="Medium">Medium</option>
            <option value="High">High</option>
        </select>

        <input
                type="text"
                id="practiceNotes"
                placeholder="Notes (optional)"
                class="practice-grid-full"
        >

        <button
                onclick="logPracticeSession()"
                class="practice-grid-full"
        >
            Log Practice Session
        </button>
    </div>

    <!-- PRACTICE HISTORY -->
    <h3>üìä Practice History</h3>
    <div id="practiceHistory" class="history-list">
        <p class="empty">No practice sessions yet</p>
    </div>

    <!-- YOUTUBE PLAYER -->
    <h3>Currently Watching</h3>
    <div class="player-wrapper">
        <div id="player"></div>
    </div>

    <!-- YOUTUBE HISTORY -->
    <h3>Previously Watched</h3>
    <div id="historyList" class="history-list">
        <p class="empty">No videos watched yet</p>
    </div>

    <div class="footer">
        Learning time is tracked automatically
    </div>
</div>

</body>


<script src="https://www.youtube.com/iframe_api"></script>

<script>
    function loadUserProgress() {
    fetch("/api/v1/progress/me")
        .then(res => res.json())
        .then(p => {
            document.getElementById("progressDashboard").innerHTML = `
                <div class="history-card">üìö Total Skills: <strong>${p.totalSkills}</strong></div>
                <div class="history-card">‚úÖ Active Skills: <strong>${p.activeSkills}</strong></div>
                <div class="history-card">‚ö†Ô∏è At-Risk Skills: <strong>${p.atRiskSkills}</strong></div>
                <div class="history-card">‚è±Ô∏è Total Practice: <strong>${p.totalPracticeMinutes} mins</strong></div>
                <div class="history-card">üóìÔ∏è Last Practice: <strong>${p.lastPracticeDate ?? "N/A"}</strong></div>
            `;
        })
        .catch(() => {
            document.getElementById("progressDashboard").innerHTML =
                `<p class="empty">Failed to load progress</p>`;
        });
}

    let player, interval = null, sessionSeconds = 0;

    document.getElementById("startBtn").onclick = startLearning;

    /* -------------------- YOUTUBE -------------------- */

    function startLearning() {
        const url = ytUrl.value.trim();
        if (!url) return alert("Paste YouTube URL");

        fetch("/api/youtube/video", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ youtubeUrl: url })
        })
        .then(() => fetch("/api/youtube/current"))
        .then(res => res.json())
        .then(data => loadPlayer(data.videoId));
    }

    function loadPlayer(videoId) {
        if (player) return player.loadVideoById(videoId);

        player = new YT.Player("player", {
            height: "360",
            width: "640",
            videoId,
            events: { onStateChange }
        });
    }

    function onStateChange(event) {
        if (event.data === YT.PlayerState.PLAYING) {
            interval = setInterval(() => sessionSeconds++, 1000);
        } else {
            sendWatchTime();
        }
    }

    function sendWatchTime() {
        if (!interval) return;
        clearInterval(interval);
        interval = null;

        if (sessionSeconds > 0) {
            const v = player.getVideoData();
            fetch("/api/youtube/watch-time", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    videoId: v.video_id,
                    title: v.title,
                    watchedSeconds: sessionSeconds
                })
            }).then(loadYoutubeHistory);

            sessionSeconds = 0;
        }
    }

    function loadYoutubeHistory() {
        fetch("/api/youtube/history")
            .then(res => res.json())
            .then(data => {
                historyList.innerHTML = data.length
                    ? data.map(v => `
                        <div class="history-card">
                            ${v.title}<br>${(v.watchedSeconds / 60).toFixed(1)} mins
                        </div>
                    `).join("")
                    : `<p class="empty">No videos watched yet</p>`;
            });
    }

    /* -------------------- PRACTICE -------------------- */
function logPracticeSession() {
    const skillName = practiceSkillName.value.trim();
    const skillId = getSkillIdByName(skillName);

    if (!skillId || !practiceDate.value ||
        !practiceDuration.value || !practiceEffort.value) {
        alert("Please select a valid skill and fill all fields");
        return;
    }

    const payload = {
        skillId: skillId,
        practiceDate: practiceDate.value,
        durationMinutes: Number(practiceDuration.value),
        effortLevel: practiceEffort.value,
        notes: practiceNotes.value
    };

    fetch("/api/v1/practice/log", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
    })
    .then(res => {
        if (!res.ok) throw new Error();
        loadPracticeHistory();
        alert("‚úÖ Practice logged");
    })
    .catch(() => alert("‚ùå Failed"));
}



    function loadPracticeHistory() {
        fetch("/api/v1/practice/my")
            .then(res => res.json())
            .then(data => {
                practiceHistory.innerHTML = data.length
                    ? data.map(p => `
                        <div class="history-card">
                            <strong>${p.skillName}</strong><br>
                            ${p.practiceDate}<br>
                            ${p.durationMinutes} mins ‚Ä¢ ${p.effortLevel}
                        </div>
                    `).join("")
                    : `<p class="empty">No practice sessions yet</p>`;
            });
    }

    function loadSkills() {
        fetch("/api/v1/skills?userId=1")

            .then(res => res.json())
            .then(data => {
                practiceSkillId.innerHTML = `<option value="">Select Skill</option>`;
                data.forEach(s =>
                    practiceSkillId.innerHTML += `<option value="${s.id}">${s.name}</option>`
                );
            });
    }
    window.onload = () => {
    loadSkills();
    loadPracticeHistory();
    loadYoutubeHistory();
    loadUserProgress();
};

</script>

</body>
</html>
